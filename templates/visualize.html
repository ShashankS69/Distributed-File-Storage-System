<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #343a40;
            overflow: hidden;
            display: flex;
            padding: 0 20px;
        }

        .navbar a {
            color: white;
            text-align: center;
            padding: 14px 20px;
            text-decoration: none;
            font-size: 17px;
            transition: background-color 0.3s;
        }

        .navbar a:hover {
            background-color: #495057;
        }

        .navbar a.active {
            background-color: #0d6efd;
        }

        .content-wrapper {
            padding: 20px;
        }

        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: space-between;
        }

        .chart-row {
            display: flex;
            width: 100%;
            gap: 15px;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .chart-container {
            width: calc(50% - 10px);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-radius: 5px;
            height: 250px;
            background-color: white;
        }

        .secondary-chart {
            width: calc(33% - 10px);
            height: 200px;
        }

        .grid-container {
            width: 100%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            background-color: white;
        }

        .file-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .file-table th {
            background-color: #f0f0f0;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
        }

        .file-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
        }

        .file-table tr:hover {
            background-color: #f9f9f9;
        }

        .chunk-indicator {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            align-items: center;
        }

        .chunk {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            display: inline-block;
        }

        h1,
        h2 {
            color: #333;
            margin-top: 0;
        }

        h2 {
            font-size: 18px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            width: 130px;
            margin: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
        }

        .volume-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: white;
            display: inline-block;
        }

        .volume1 {
            background-color: #3498db;
        }

        .volume2 {
            background-color: #2ecc71;
        }

        .sync-card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .sync-history {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .sync-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .sync-item:last-child {
            border-bottom: none;
        }

        .sync-badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: white;
        }

        .sync-success {
            background-color: #2ecc71;
        }

        .sync-pending {
            background-color: #f39c12;
        }

        .sync-error {
            background-color: #e74c3c;
        }

        .sync-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <a href="/">Upload</a>
        <a href="/retrieve">Retrieve</a>
        <a href="/visualize" class="active">Visualize</a>
    </div>

    <div class="content-wrapper">
        <h1>Storage System Visualization</h1>

        <div class="stats">
            <div class="stat-box">
                <div>Total Files</div>
                <div class="stat-value" id="total-files">0</div>
            </div>
            <div class="stat-box">
                <div>Total Size</div>
                <div class="stat-value" id="total-size">0 MB</div>
            </div>
            <div class="stat-box">
                <div>Volume 1 Health</div>
                <div class="stat-value" id="vol1-health">Unknown</div>
            </div>
            <div class="stat-box">
                <div>Volume 2 Health</div>
                <div class="stat-value" id="vol2-health">Unknown</div>
            </div>
            <div class="stat-box">
                <div>Sync Status</div>
                <div class="stat-value" id="sync-status">Idle</div>
            </div>
        </div>

        <div class="sync-card">
            <h2>Synchronization Status</h2>
            <div class="sync-status">
                <div>
                    <strong>Last Sync:</strong> <span id="last-sync-time">Never</span>
                </div>
                <div>
                    <strong>Nodes Synced:</strong> <span id="synced-nodes">0</span>
                </div>
                <div>
                    <button id="request-sync" onclick="requestSync()"
                        style="padding: 5px 10px; background-color: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Request Health Sync
                    </button>
                </div>
            </div>
            <h3>Recent Sync History</h3>
            <div class="sync-history" id="sync-history">
                <div class="sync-item">
                    <span>Waiting for sync events...</span>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="chart-row">
                <div class="chart-container">
                    <h2>Storage Usage</h2>
                    <canvas id="storageChart"></canvas>
                </div>
                <div class="chart-container">
                    <h2>File Distribution</h2>
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>

            <div class="chart-row">
                <div class="chart-container secondary-chart">
                    <h2>Storage Trend</h2>
                    <canvas id="storageTrendChart"></canvas>
                </div>
                <div class="chart-container secondary-chart">
                    <h2>Upload Activity</h2>
                    <canvas id="uploadActivityChart"></canvas>
                </div>
                <div class="chart-container secondary-chart">
                    <h2>File Type Distribution</h2>
                    <canvas id="fileTypeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid-container">
            <h2>Files List</h2>
            <table class="file-table">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Size</th>
                        <th>Chunks</th>
                        <th>Distribution</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="file-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const socket = io();
        let storageChart, distributionChart, storageTrendChart, uploadActivityChart, fileTypeChart;
        let storageHistory = [];
        let syncHistory = [];

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function initCharts(data) {
            const storageCtx = document.getElementById('storageChart').getContext('2d');
            storageChart = new Chart(storageCtx, {
                type: 'pie',
                data: {
                    labels: ['Volume 1 Used', 'Volume 1 Free', 'Volume 2 Used', 'Volume 2 Free'],
                    datasets: [{
                        data: [
                            data.volume1.used,
                            data.volume1.total - data.volume1.used,
                            data.volume2.used,
                            data.volume2.total - data.volume2.used
                        ],
                        backgroundColor: ['#3498db', '#93c5fd', '#2ecc71', '#a7f3d0']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.raw;
                                    const percentage = Math.round((value / (data.volume1.total + data.volume2.total)) * 100);
                                    return `${context.label}: ${formatBytes(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            const trendCtx = document.getElementById('storageTrendChart').getContext('2d');
            storageTrendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [...Array(10).keys()].map(n => `T-${9 - n}`),
                    datasets: [
                        {
                            label: 'Volume 1',
                            data: Array(10).fill(0),
                            borderColor: '#3498db',
                            tension: 0.1
                        },
                        {
                            label: 'Volume 2',
                            data: Array(10).fill(0),
                            borderColor: '#2ecc71',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return formatBytes(value, 0);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });

            const activityCtx = document.getElementById('uploadActivityChart').getContext('2d');
            uploadActivityChart = new Chart(activityCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Uploads',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: '#9b59b6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });

            const fileTypeCtx = document.getElementById('fileTypeChart').getContext('2d');
            fileTypeChart = new Chart(fileTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Documents', 'Images', 'Videos', 'Others'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#f1c40f', '#e74c3c', '#1abc9c', '#95a5a6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });

            storageHistory.push({
                time: new Date(),
                vol1: data.volume1.used,
                vol2: data.volume2.used
            });
            if (storageHistory.length > 10) {
                storageHistory.shift();
            }
            updateStorageTrendChart();
        }

        function updateStorageTrendChart() {
            if (storageTrendChart && storageHistory.length > 0) {
                storageTrendChart.data.labels = storageHistory.map((_, idx) =>
                    `T-${storageHistory.length - 1 - idx}`);
                storageTrendChart.data.datasets[0].data = storageHistory.map(h => h.vol1);
                storageTrendChart.data.datasets[1].data = storageHistory.map(h => h.vol2);
                storageTrendChart.update();
            }
        }

        function updateFileGrid() {
            fetch('/files')
                .then(response => response.json())
                .then(files => {
                    const tableBody = document.getElementById('file-tbody');
                    tableBody.innerHTML = '';

                    document.getElementById('total-files').textContent = files.length;

                    let totalSize = 0;
                    let volumeDistribution = {
                        'volume1': 0,
                        'volume2': 0
                    };

                    let fileTypes = {
                        'Documents': 0,
                        'Images': 0,
                        'Videos': 0,
                        'Others': 0
                    };

                    files.forEach(file => {
                        totalSize += file.size;

                        const ext = file.filename.split('.').pop().toLowerCase();
                        if (['doc', 'docx', 'pdf', 'txt', 'xls', 'xlsx'].includes(ext)) {
                            fileTypes['Documents']++;
                        } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext)) {
                            fileTypes['Images']++;
                        } else if (['mp4', 'mov', 'avi', 'wmv', 'flv', 'mkv'].includes(ext)) {
                            fileTypes['Videos']++;
                        } else {
                            fileTypes['Others']++;
                        }

                        const row = document.createElement('tr');

                        const filenameCell = document.createElement('td');
                        filenameCell.textContent = file.filename;
                        row.appendChild(filenameCell);

                        const sizeCell = document.createElement('td');
                        sizeCell.textContent = formatBytes(file.size);
                        row.appendChild(sizeCell);

                        const chunksCell = document.createElement('td');
                        chunksCell.textContent = file.chunks;
                        row.appendChild(chunksCell);

                        const distributionCell = document.createElement('td');
                        const chunkIndicator = document.createElement('div');
                        chunkIndicator.className = 'chunk-indicator';

                        const vol1Badge = document.createElement('span');
                        vol1Badge.className = 'volume-badge volume1';
                        vol1Badge.textContent = 'Vol 1';
                        chunkIndicator.appendChild(vol1Badge);

                        for (let i = 0; i < Math.min(file.chunks, 5); i++) {
                            const chunkDiv = document.createElement('div');
                            chunkDiv.className = 'chunk';
                            chunkDiv.style.backgroundColor = Math.random() > 0.5 ? '#3498db' : '#2ecc71';
                            chunkIndicator.appendChild(chunkDiv);
                        }

                        if (file.chunks > 5) {
                            const ellipsis = document.createElement('span');
                            ellipsis.textContent = '...';
                            chunkIndicator.appendChild(ellipsis);
                        }

                        const vol2Badge = document.createElement('span');
                        vol2Badge.className = 'volume-badge volume2';
                        vol2Badge.textContent = 'Vol 2';
                        chunkIndicator.appendChild(vol2Badge);

                        distributionCell.appendChild(chunkIndicator);
                        row.appendChild(distributionCell);

                        const actionsCell = document.createElement('td');
                        const downloadLink = document.createElement('a');
                        downloadLink.href = `/download/${file.filename}`;
                        downloadLink.textContent = 'Download';
                        downloadLink.style.marginRight = '10px';
                        actionsCell.appendChild(downloadLink);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.onclick = function () { deleteFile(file.filename); };
                        deleteBtn.style.border = 'none';
                        deleteBtn.style.background = '#dc3545';
                        deleteBtn.style.color = 'white';
                        deleteBtn.style.padding = '3px 8px';
                        deleteBtn.style.borderRadius = '3px';
                        deleteBtn.style.cursor = 'pointer';
                        actionsCell.appendChild(deleteBtn);

                        row.appendChild(actionsCell);

                        tableBody.appendChild(row);
                    });

                    document.getElementById('total-size').textContent = formatBytes(totalSize);

                    if (fileTypeChart) {
                        fileTypeChart.data.datasets[0].data = [
                            fileTypes['Documents'],
                            fileTypes['Images'],
                            fileTypes['Videos'],
                            fileTypes['Others']
                        ];
                        fileTypeChart.update();
                    }

                    const storageInfo = {{ storage_info | tojson
                }};
        if (storageInfo.distribution) {
            const vol1Count = storageInfo.distribution.volume1;
            const vol2Count = storageInfo.distribution.volume2;

            if (distributionChart) {
                distributionChart.destroy();
            }

            const distCtx = document.getElementById('distributionChart').getContext('2d');
            distributionChart = new Chart(distCtx, {
                type: 'pie',
                data: {
                    labels: ['Volume 1', 'Volume 2'],
                    datasets: [{
                        data: [vol1Count, vol2Count],
                        backgroundColor: ['#3498db', '#2ecc71']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.raw;
                                    const total = vol1Count + vol2Count;
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${context.label}: ${value} chunks (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
                });
        }

        function deleteFile(filename) {
            if (confirm(`Are you sure you want to delete ${filename}?`)) {
                fetch(`/delete/${filename}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('File deleted successfully');
                            updateFileGrid();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error);
                    });
            }
        }

        function requestSync() {
            socket.emit('request_health_sync');
            document.getElementById('sync-status').textContent = 'Syncing...';
            addSyncEvent('Requested health synchronization', 'pending');
        }

        function addSyncEvent(message, status = 'success') {
            const now = new Date();
            const timeString = now.toLocaleTimeString();

            syncHistory.push({
                message: message,
                time: timeString,
                status: status,
                timestamp: now
            });

            if (syncHistory.length > 10) {
                syncHistory.shift();
            }

            updateSyncHistory();

            if (status === 'success') {
                document.getElementById('last-sync-time').textContent = timeString;
            }
        }

        function updateSyncHistory() {
            const historyContainer = document.getElementById('sync-history');
            historyContainer.innerHTML = '';

            syncHistory.forEach(event => {
                const item = document.createElement('div');
                item.className = 'sync-item';

                const message = document.createElement('span');
                message.textContent = event.message;

                const timeAndStatus = document.createElement('div');

                const time = document.createElement('span');
                time.textContent = event.time + ' ';

                const status = document.createElement('span');
                status.className = `sync-badge sync-${event.status}`;
                status.textContent = event.status.toUpperCase();

                timeAndStatus.appendChild(time);
                timeAndStatus.appendChild(status);

                item.appendChild(message);
                item.appendChild(timeAndStatus);

                historyContainer.appendChild(item);
            });
        }

        socket.on('storage_update', function (data) {
            document.getElementById('vol1-health').textContent = data.health_status.volume1 ? 'OK' : 'ERROR';
            document.getElementById('vol2-health').textContent = data.health_status.volume2 ? 'OK' : 'ERROR';

            storageHistory.push({
                time: new Date(),
                vol1: data.volume1.used,
                vol2: data.volume2.used
            });
            if (storageHistory.length > 10) {
                storageHistory.shift();
            }

            if (storageChart) {
                storageChart.data.datasets[0].data = [
                    data.volume1.used,
                    data.volume1.total - data.volume1.used,
                    data.volume2.used,
                    data.volume2.total - data.volume2.used
                ];
                storageChart.update();
            } else {
                initCharts(data);
            }

            updateStorageTrendChart();
            updateFileGrid();

            if (uploadActivityChart) {
                const day = new Date().getDay();
                uploadActivityChart.data.datasets[0].data[day] += 1;
                uploadActivityChart.update();
            }

            if (data.health_status) {
                addSyncEvent('Volume health status updated', 'success');
                document.getElementById('sync-status').textContent = 'Synced';
            }
        });

        socket.on('cs_request', function (data) {
            addSyncEvent(`Sync request from ${data.from_node.substring(0, 6)}...`, 'pending');
        });

        socket.on('cs_reply', function (data) {
            addSyncEvent(`Sync reply received from ${data.from_node ? data.from_node.substring(0, 6) + '...' : 'a node'}`, 'success');
        });

        socket.on('health_update', function (data) {
            const syncNodes = document.getElementById('synced-nodes');
            const currentCount = parseInt(syncNodes.textContent) || 0;
            syncNodes.textContent = currentCount + 1;

            addSyncEvent('Health data synchronized', 'success');
            document.getElementById('sync-status').textContent = 'Synced';
        });

        document.addEventListener('DOMContentLoaded', function () {
            const storageInfo = {{ storage_info | tojson
        }};
        initCharts(storageInfo);

        document.getElementById('vol1-health').textContent =
            storageInfo.health_status.volume1 ? 'OK' : 'ERROR';
        document.getElementById('vol2-health').textContent =
            storageInfo.health_status.volume2 ? 'OK' : 'ERROR';

        updateFileGrid();

        addSyncEvent('System initialized', 'success');
        document.getElementById('last-sync-time').textContent = new Date().toLocaleTimeString();
        document.getElementById('synced-nodes').textContent = '1';
        });
    </script>
</body>

</html>